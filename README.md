
# Деплой

Деплой состоит из двух шагов: 

- сначала проставляем тег коммиту, происходит сборка и выкладка на stage,
- потом идем на битбакет и заканчиваем пайплайн вручную, запустив последний шаг - выкладку на прод.


## 1. Простановка тегов + выкладка на stage


### 1.1. Через интерфейс битбакета (просто):

- Открываем код на битбакете, находим нужный коммит и добавляем ему тег.


### 1.2. Через консоль (сложно):

- Загружаем локально все теги удаленного репо 

```
git fetch --tags
```

- Проверяем, какой тег был последний. Либо смотрим в браузере на битбакете, либо через консоль:

```bash
git fetch --tags && git describe --tags
```

- Ставим новый тег:


```bash
git tag XXX
```

- Пушим код с тегом:

```bash
git push origin master --tags
```

### 2. Выкладка на прод

- идем на битбакет, открываем нужный коммит, открываем его пайплайн
- В пайплайне будут выполнены 2 шага (сборка и выкладка на stage), третий будет ожидать ручного запуска
- жмем Run напротив третьего шага, код будет загружен на прод.



### 3. Если деплой не прошел

Чтобы не мусорить тегами - если деплой кривой или если версия бажная, нужно стереть тег и поставить заново:

```bash

# Стираем бажный тег локально
git tag -d x.x.x

# Стираем бажный тег удаленно
git push origin --delete x.x.x

# Ставим этот же тег заново на новый коммит и пушим
git tag x.x.x
git push origin master --tags
```


### 4. Стейджинг

Выкладка на стейдж происходит автоматически после простановки тега, руками ничего делать не нужно. Это второй шаг пайплйна, он сам запустится после сборки.
Во время выкладки на стейдж выбранный коммит будет загружен на стейджинговый URL `/widget_stage/`.

Как открыть виджет на стейджинге?

- Берем скрипт с прода конструктора: `<script src="https://fstrkchat.com/widget/xxxxx.js"></script>`
- дописываем гет-параметр `?stage=1`, получаем: `<script src="https://fstrkchat.com/widget/xxxxx.js?stage=1"></script>`

Готово, вставляем это в браузер внутрь тег `<body>`, этот скрипт подгрузит стейджинговую версию.
